<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Excel Data Viewer</title>
    <base href="./">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css">
    <link rel="stylesheet" href="../style.css"> <style>
        /* Minimal styling with button styles */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #D4D4D4;
        }
        #sheet-container {
            margin-top: 20px;
        }
        .sheet-table-container {
            margin-bottom: 20px;
        }
        .sheet-table-container h2 {
            margin-top: 0;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        #button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        #button-container button {
            padding: 12px 18px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        #button-container button:hover {
            background-color: #222;
        }
        #button-container button.active {
            background-color: #4CAF50;
            color: white;
        }
        #view-all-button {
            padding: 12px 18px;
            background-color: #e0e0e0;
            color: #333;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        #view-all-button:hover {
            background-color: #ccc;
        }
        #back-to-portal {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        #back-to-portal:hover {
            background-color: #0056b3;
        }

        /* Styling for the save status message */
        #save-status {
            margin-top: 10px;
            font-weight: bold;
        }
        #save-status.success {
            color: green;
        }
        #save-status.error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Group A - Charts of Accounts</h1>
    <nav>
        <a href="index.html">Home</a> |
        <a href="group-a.html">Group A</a>
        </nav>

    <div id="saveStatus" style="margin-top: 10px; font-weight: bold;"></div>
    <div id="excel-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css" rel="stylesheet">
    
<script>
    // Make sure this URL is correct and points to your deployed Render backend
    const BACKEND_URL = 'YOUR_RENDER_BACKEND_URL_HERE'; // <-- Confirm this is your actual Render URL

    const container = document.getElementById('excel-container');
    const saveStatusDiv = document.getElementById('saveStatus'); // Make sure you have <div id="saveStatus"></div> in your HTML

    let hot; // Declare Handsontable instance globally so we can access it

    // Function to initialize Handsontable with data
    async function initializeHandsontable(data) {
        // Ensure data is structured correctly for Handsontable
        // If data is coming from MongoDB, it will be an array of objects like {sheetName, row, col, cellValue}
        // Handsontable expects a 2D array for its data property

        // For now, let's assume we initialize with a basic 10x10 empty grid,
        // and then overlay the saved data.
        const initialData = Handsontable.helper.createEmptySpreadsheetData(10, 10);
        
        hot = new Handsontable(container, {
            data: initialData, // Start with empty data
            rowHeaders: true,
            colHeaders: true,
            width: 'auto',
            height: 'auto',
            stretchH: 'all',
            licenseKey: 'non-commercial-and-evaluation', // For non-commercial use
            readOnly: false, // Enable editing

            // THIS IS THE CRUCIAL PART FOR UPDATING CELLS
            afterChange: async function(changes, source) {
                if (source === 'loadData') { // Don't save when data is loaded initially
                    return;
                }
                if (!changes) { // No changes to process
                    return;
                }

                saveStatusDiv.textContent = 'Saving...';
                saveStatusDiv.style.color = 'orange';

                for (let i = 0; i < changes.length; i++) {
                    const [row, prop, oldValue, newValue] = changes[i];
                    // 'prop' is the column header, for Handsontable it's often the column index
                    const col = typeof prop === 'number' ? prop : Handsontable.helper.columnNameToNumber(prop);

                    // Assuming you have a way to get the current active sheet name
                    // For now, we'll hardcode 'Sheet1' or get it from a global variable if available
                    // You might need to adjust this if your frontend handles multiple sheets
                    const activeSheetName = 'CHARTS OF ACCOUNTS'; // ENSURE NO TRAILING SPACE HERE

                    try {
                        const response = await fetch(`${BACKEND_URL}/api/updateExcel`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                sheetName: activeSheetName,
                                row: row,
                                col: col,
                                newValue: newValue
                            }),
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Frontend: Save successful', result);
                            // Update status message based on modifiedCount/upsertedCount
                            if (result.modifiedCount > 0) {
                                saveStatusDiv.textContent = 'Saved (Modified)';
                                saveStatusDiv.style.color = 'green';
                            } else if (result.upsertedCount > 0) {
                                saveStatusDiv.textContent = 'Saved (Inserted)';
                                saveStatusDiv.style.color = 'blue';
                            } else {
                                saveStatusDiv.textContent = 'Saved (No Change)';
                                saveStatusDiv.style.color = 'grey'; // If matchedCount is 1 but modifiedCount is 0
                            }
                            // Clear message after a short delay
                            setTimeout(() => { saveStatusDiv.textContent = ''; }, 3000); 

                        } else {
                            const errorData = await response.json();
                            console.error('Frontend: Save failed:', errorData);
                            saveStatusDiv.textContent = `Error: ${errorData.message || 'Failed to save'}`;
                            saveStatusDiv.style.color = 'red';
                             setTimeout(() => { saveStatusDiv.textContent = ''; }, 5000); 
                        }
                    } catch (error) {
                        console.error('Frontend: Network error during save:', error);
                        saveStatusDiv.textContent = `Network Error: ${error.message}`;
                        saveStatusDiv.style.color = 'red';
                         setTimeout(() => { saveStatusDiv.textContent = ''; }, 5000); 
                    }
                }
            }
        });
        
        // After Handsontable is initialized, overlay the saved data
        // from MongoDB onto the grid.
        if (data && data.length > 0) {
            data.forEach(cell => {
                // Trim both sheet names before comparison to ignore leading/trailing spaces
                if (cell.sheetName.trim() === activeSheetName.trim()) { // Use activeSheetName for consistency
                    hot.setDataAtCell(cell.row, cell.col, cell.cellValue, 'loadData');
                }
            });
        }
    }

    // Function to fetch data from backend and then initialize Handsontable
    async function loadDataAndInitializeHandsontable() {
        saveStatusDiv.textContent = 'Loading data...';
        saveStatusDiv.style.color = 'blue';
        try {
            const response = await fetch(`${BACKEND_URL}/api/getExcelData`);
            if (response.ok) {
                const savedData = await response.json();
                console.log('Frontend: Data loaded successfully:', savedData);
                await initializeHandsontable(savedData); // Initialize with fetched data
                saveStatusDiv.textContent = 'Data loaded!';
                saveStatusDiv.style.color = 'green';
                setTimeout(() => { saveStatusDiv.textContent = ''; }, 2000); 
            } else {
                const errorData = await response.json();
                console.error('Frontend: Failed to load data:', errorData);
                saveStatusDiv.textContent = `Error loading data: ${errorData.message || 'Failed to load'}`;
                saveStatusDiv.style.color = 'red';
                setTimeout(() => { saveStatusDiv.textContent = ''; }, 5000); 
                // If loading fails, still initialize with empty Handsontable
                await initializeHandsontable([]); 
            }
        } catch (error) {
            console.error('Frontend: Network error during data load:', error);
            saveStatusDiv.textContent = `Network Error loading data: ${error.message}`;
            saveStatusDiv.style.color = 'red';
            setTimeout(() => { saveStatusDiv.textContent = ''; }, 5000); 
            // If loading fails, still initialize with empty Handsontable
            await initializeHandsontable([]); 
        }
    }

    // Call the function to load data and initialize Handsontable when the DOM is ready
    document.addEventListener('DOMContentLoaded', loadDataAndInitializeHandsontable);

</script>
</body>
</html>
